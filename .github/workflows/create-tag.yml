name: Create Tag

on:
  push:
    branches:
      - 'main'
    paths:
      - 'plugin/CactbotEventSource/Properties/AssemblyInfo.cs'
      - 'plugin/CactbotOverlay/Properties/AssemblyInfo.cs'

jobs:
  create-tag:
    runs-on: ubuntu-latest
    if: ${{ github.repository == 'quisquous/cactbot' }}
    env:
      GITHUB_TOKEN: ${{ secrets.BOT_TOKEN }}
    steps:
      - name: Checkout Code
        uses: actions/checkout@v2
      - name: Parse Version
        id: parse-version
        run: |
          # Parse new tag from package.json
          VERSION="$(cat package.json | sed -ne 's/"version": "\([0-9]*\.[0-9]*\.[0-9]*\)",/\1/p')"

          # Write version to both AssemblyInfo files
          sed -i "s/\(.*Version.*\)\"\([0-9]*\.[0-9]*\.[0-9]*\.0\)\"/\1\"${VERSION}.0\"/g" plugin/CactbotEventSource/Properties/AssemblyInfo.cs plugin/CactbotOverlay/Properties/AssemblyInfo.cs

          # Output version
          echo "VERSION=$VERSION" >> $GITHUB_ENV
      - name: Check Existing Tags
        run: |
          if ! curl -fsL https://api.github.com/repos/quisquous/cactbot/git/refs/tags/v${{ env.VERSION }}; then
            echo "No existing tags for the version number exist. Creating new tag..."
          else
            echo "Tagged version already exists. Skipping tag creation..."
            exit 1
          fi
      - name: Create Tag
        run: |
          # Get current commit hash
          commit=$(git rev-parse HEAD)

          # POST a new ref to repo via Github API
          curl -s -X POST https://api.github.com/repos/quisquous/cactbot/git/refs \
          -H "Authorization: token $GITHUB_TOKEN" \
          -d @- << EOF
          {
            "ref": "refs/tags/v${{ env.VERSION }}",
            "sha": "$commit"
          }
          EOF
